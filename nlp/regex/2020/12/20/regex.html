<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">A surprising bug caused by regex</h1><p class="page-description">My program to process hundreds of documents would mysteriously stop on a particular document. After a couple of hours of checking all my code, I managed to isolate the problem to a particular regex search. I describe what I learnt in this blog post.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-12-20T00:00:00-06:00" itemprop="datePublished">
        Dec 20, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#nlp">nlp</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#regex">regex</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h2"><a href="#catastrophic-backtracking">Catastrophic backtracking</a></li>
<li class="toc-entry toc-h2"><a href="#a-solution">A solution</a></li>
<li class="toc-entry toc-h2"><a href="#conclusions">Conclusions</a></li>
</ul><h2 id="introduction">
<a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>
<p>In my <a href="https://faculty.ai/fellowship/">Faculty Fellowship</a>, my project was to analyse legal deposition transcripts using NLP. As always, the first step was to clean the data and extract the useful information from the raw text from the transcripts.</p>

<p>I created a bunch of functions to do this processing and tested it on a few documents, and it all seemed fine.  I then ran the program on the complete set of documents, but it would mysteriously get stuck on a particular transcript.  After spending a couple of hours combing through my code, I managed to isolate the problem to this innocent looking regex search:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pat</span> <span class="o">=</span> <span class="s">r'BY (M[RS]\. ([A-Z]+ ?)+|([A-Z]+ ?)+, ESQ)'</span>
<span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="s">'SAME BY ANY MEANS UNLESS UNDER THE DIRECT CONTROL'</span><span class="p">)</span>
</code></pre></div></div>

<p>The pattern is looking for something like ‘BY MR. JOHN SMITH’ or ‘BY JOHN SMITH, ESQ’.</p>

<p>I was extremely confused. Why should this regex search break anything? It obviously should return false: there is so ‘MR’ or ‘MS’ or ‘ESQ’ in the string, so why is it breaking?</p>

<h2 id="catastrophic-backtracking">
<a class="anchor" href="#catastrophic-backtracking" aria-hidden="true"><span class="octicon octicon-link"></span></a>Catastrophic backtracking</h2>
<p>I asked about this in the Faculty Slack channel, and I was helpfully directed towards the fantastic resource <a href="regex101.com">regex101</a>. If you enter the regex pattern and string from above into the website, it reveals the problem is ‘catastrophic backtracking’. This basically means that the search tree that is used behind the scenes is humungous - leading to a regex search that would take forever to complete.</p>

<p>More explicitly, instead of searching for ‘ESQ’ up front, the regex search function creates all possible candidate strings that match the rest of the regex pattern, and then checks if each of those have ‘ESQ’ at the end. Based on how I wrote the pattern, the total number of possible candidate strings is enormous, because every substring of characters corresponds to a branch point in the tree.</p>

<h2 id="a-solution">
<a class="anchor" href="#a-solution" aria-hidden="true"><span class="octicon octicon-link"></span></a>A solution</h2>
<p>A simple solution was to add a word boundary:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BY</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">RS</span><span class="p">]</span>\<span class="o">.</span> <span class="p">([</span><span class="n">A</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span>\<span class="n">b</span> <span class="err">?</span><span class="p">)</span><span class="o">+|</span><span class="p">([</span><span class="n">A</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span>\<span class="n">b</span> <span class="err">?</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="n">ESQ</span><span class="p">)</span>
</code></pre></div></div>
<p>This prevents branching occuring at every single character, and instead branching only occurs at every single word boundary.</p>

<h2 id="conclusions">
<a class="anchor" href="#conclusions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusions</h2>
<ul>
  <li>
<a href="regex101.com">regex101</a> is a fantastic tool! I will be using this any time I need to use regex in the future.</li>
  <li>Debugging is harder than I already thought it was. Even things which I think are completely safe can be the cause of bugs.</li>
</ul>

  </div><a class="u-url" href="/blog/nlp/regex/2020/12/20/regex.html" hidden></a>
</article>