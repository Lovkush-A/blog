<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Bacon numbers via Recursive SQL</h1><p class="page-description">I create a table of actors and their bacon numbers using recursion in SQL. The largest finite bacon number is 13.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-05-24T00:00:00-05:00" itemprop="datePublished">
        May 24, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#sql">sql</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#python">python</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#sql-in-python">SQL in Python</a></li>
<li class="toc-entry toc-h2"><a href="#understanding-the-database">Understanding the database</a></li>
<li class="toc-entry toc-h2"><a href="#the-recursive-query">The recursive query</a></li>
<li class="toc-entry toc-h2"><a href="#bacon-number-of-13">Bacon number of 13</a></li>
</ul><h2 id="sql-in-python">
<a class="anchor" href="#sql-in-python" aria-hidden="true"><span class="octicon octicon-link"></span></a>SQL in Python</h2>
<p>I ran the SQL commands in Python using the module sqlite3. I used <a href="https://swcarpentry.github.io/sql-novice-survey/10-prog/index.html">this article</a> to help me set it all up. Below is the code to run queries on the database <em>movies.db</em> in python.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kn">import</span> <span class="nn">sqlite3</span>

    <span class="k">def</span> <span class="nf">run_sql</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'movies.db'</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div>

<h2 id="understanding-the-database">
<a class="anchor" href="#understanding-the-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>Understanding the database</h2>
<p>The data is in the form of a database, <em>movies.db</em>, and was obtained from the online course <a href="https://cs50.harvard.edu/x/2020/psets/7/movies/">CS50</a>, which in turn was obtained from imdb. To find out the structure of the tables in the database, I ran the following code (obtained from <a href="https://stackoverflow.com/questions/305378/list-of-tables-db-schema-dump-etc-using-the-python-sqlite3-api">stackoverflow</a>).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">produce_schema</span><span class="p">():</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT name FROM sqlite_master WHERE type = 'table';"</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="n">run_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">f</span><span class="s">"SELECT sql FROM sqlite_master WHERE type = 'table' and name = '{table[0]}'"</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">run_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">schema</span><span class="p">[</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
        <span class="k">return</span> <span class="n">schema</span>

    <span class="n">produce_schema</span><span class="p">()</span>
</code></pre></div></div>

<p>For the task of determining bacon numbers, the relevant tables and columns are:</p>
<ul>
  <li>
<code class="highlighter-rouge">people</code>, with columns <code class="highlighter-rouge">id</code> and <code class="highlighter-rouge">name</code>. Each person has a unique id. There are 1044499 people in the table.</li>
  <li>
<code class="highlighter-rouge">stars</code>, with columns <code class="highlighter-rouge">movie_id</code> and <code class="highlighter-rouge">person_id</code>. Each row tells you that the actor with id <code class="highlighter-rouge">person_id</code> starred in the movie with id <code class="highlighter-rouge">movie_id</code>.</li>
</ul>

<p>Kevin Bacon has an id of 102, found by running the query <code class="highlighter-rouge">SELECT id FROM people WHERE name = 'Kevin Bacon' </code></p>

<h2 id="the-recursive-query">
<a class="anchor" href="#the-recursive-query" aria-hidden="true"><span class="octicon octicon-link"></span></a>The recursive query</h2>
<p>To understand recursion in SQL, I recommend <a href="https://www.essentialsql.com/recursive-ctes-explained/">this guide</a> which explains recursion and how to use recursion in SQL, and then the <a href="https://www.sqlite.org/lang_with.html">SQLite documentation</a> to better understand some implementation details and what options are available to you.</p>

<p>The query I created to produce the table of bacon numbers is:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">WITH</span> <span class="k">RECURSIVE</span>
     <span class="n">costars</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span> <span class="k">AS</span>
     <span class="p">(</span> 
       <span class="k">SELECT</span> <span class="n">stars1</span><span class="p">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">stars2</span><span class="p">.</span><span class="n">person_id</span>
       <span class="k">FROM</span> <span class="n">stars</span> <span class="k">AS</span> <span class="n">stars1</span>
       <span class="k">JOIN</span> <span class="n">stars</span> <span class="k">AS</span> <span class="n">stars2</span>
       <span class="k">ON</span> <span class="n">stars1</span><span class="p">.</span><span class="n">movie_id</span> <span class="o">=</span> <span class="n">stars2</span><span class="p">.</span><span class="n">movie_id</span>
     <span class="p">),</span>
     <span class="n">bacon</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="k">AS</span>
     <span class="p">(</span>
       <span class="k">VALUES</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
       <span class="k">UNION</span>
       <span class="k">SELECT</span> <span class="n">id2</span><span class="p">,</span> <span class="n">num</span><span class="o">+</span><span class="mi">1</span>
       <span class="k">FROM</span> <span class="n">bacon</span> <span class="k">JOIN</span> <span class="n">costars</span>
       <span class="k">ON</span> <span class="n">bacon</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">costars</span><span class="p">.</span><span class="n">id1</span>
       <span class="k">WHERE</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">13</span>
     <span class="p">)</span>
     <span class="k">SELECT</span> <span class="n">bacon</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">MIN</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
     <span class="k">FROM</span> <span class="n">bacon</span> <span class="k">JOIN</span> <span class="n">people</span> <span class="k">ON</span> <span class="n">bacon</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">people</span><span class="p">.</span><span class="n">id</span>
     <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">bacon</span><span class="p">.</span><span class="n">id</span>
     <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">num</span>
</code></pre></div></div>

<ul>
  <li>The table <code class="highlighter-rouge">costars</code> lists all pairs of actors that co-starred in a movie. This is obtained by doing a self-join of the stars table.</li>
  <li>The table <code class="highlighter-rouge">bacon</code> is the main table. <code class="highlighter-rouge">id</code> is the id of the actor and <code class="highlighter-rouge">num</code> is the bacon number.
    <ul>
      <li>It starts off with the entry <code class="highlighter-rouge">(102,0)</code>.  102 is Kevin Bacon’s id and 0 is Kevin Bacon’s Bacon number.</li>
      <li>Then for any entry <code class="highlighter-rouge">(id, num)</code> already in the table, we add a new row <code class="highlighter-rouge">(id2, num+1)</code>, whenever <code class="highlighter-rouge">id2</code> co-starred with <code class="highlighter-rouge">id</code>.</li>
      <li>
<code class="highlighter-rouge">num &lt; 13</code> indicates we will only have a maximum bacon number of 13. Without this manual limit, the recursive query would never end. This is because the underlying data is not acyclic: e.g. if a is a co-star with b, then b is a co-star of a. The number 13 was chosen via trial-and-error. The resulting table does not change if I increase the limit further, which implies that the maximum bacon number is 13.</li>
    </ul>
  </li>
  <li>In the end, I select the relevant data from this recursive construction. Because each actor can appear many times in this construction, I use <code class="highlighter-rouge">GROUP BY</code> to ensure each actor appears only once. I use <code class="highlighter-rouge">MIN(num)</code> to select each actor’s earliest appearance.</li>
</ul>

<p>The two main problems with this query are that:</p>
<ul>
  <li>It is inefficient. There is huge redundancy as actors appear many times in the recursive construction. I do not think there is a way of avoiding this within SQL.</li>
  <li>I have to know what the maximum Bacon number is for the query to produce a complete list. I found this using trial-and-error.</li>
</ul>

<h2 id="bacon-number-of-13">
<a class="anchor" href="#bacon-number-of-13" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bacon number of 13</h2>
<p>By running a simple query, I find there are two people with the maximum bacon number of 13, Javier Ordonez and Kimberly Peters.  Using the program created for <a href="https://cs50.harvard.edu/ai/2020/projects/0/degrees/">this CS50 AI</a> project, I could find the path from these actors to Kevin Bacon. As expected, it takes 13 steps (always satisfying to see two different programs being consistent!) and they are below. Note they have the same path.</p>

<ol>
  <li>Javier Ordonez/Kimberly Peters and Amanda Brass starred in PRND</li>
  <li>Amanda Brass and Michael Bayouth starred in Park Reverse Neutral Drive, PRND (Director’s cut)</li>
  <li>Michael Bayouth and Brandy Bourdeaux starred in Grease Trek</li>
  <li>Brandy Bourdeaux and Kim Beuché starred in Murder Inside of Me</li>
  <li>Kim Beuché and Ed Baccari starred in Island, Alicia</li>
  <li>Ed Baccari and Aida Angotti starred in Late Watch</li>
  <li>Aida Angotti and Lamont Copeland starred in Bottom Out</li>
  <li>Lamont Copeland and Ashley Marie Arnold starred in Eye Was Blind</li>
  <li>Ashley Marie Arnold and Sid Bernstein starred in The Rodnees: We Mod Like Dat!</li>
  <li>Sid Bernstein and Chuck Berry starred in The Beatles: The Lost Concert</li>
  <li>Chuck Berry and Eric Clapton starred in Chuck Berry Hail! Hail! Rock ‘n’ Roll</li>
  <li>Eric Clapton and Tom Cruise starred in Close Up</li>
  <li>Tom Cruise and Kevin Bacon starred in A Few Good Men</li>
</ol>


  </div><a class="u-url" href="/blog/sql/python/2020/05/24/recursion_sql.html" hidden></a>
</article>